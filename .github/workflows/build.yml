name: build deno 1.36 android binding

on:
  push:
    branches: ["master"]

jobs:
  # build deno 1.36 for `aarch64-linux-android`
  build_android:
    runs-on: ubuntu-latest

    steps:
    - uses: docker/setup-qemu-action@v2
      with:
        platforms: arm64
    # setup QEMU aarch64 for termux-docker
    - run: docker run --rm --privileged aptman/qus -s -- -p aarch64 arm

    - uses: actions/checkout@v4
    - run: git submodule update --init --recursive
    # download `librusty_v8.a` for `lib_v8`
    - uses: robinraju/release-downloader@v1
      with:
        repository: "fm-elpac/v8-src"
        tag: "rusty_v8-0.75.0"
        fileName: "v0.75.0-librusty_v8_release_aarch64-linux-android.a.zst"
    - run: mv v0.75.0-librusty_v8_release_aarch64-linux-android.a.zst librusty_v8_release_aarch64-linux-android.a.zst
    - run: zstd -d librusty_v8_release_aarch64-linux-android.a.zst

    - uses: robinraju/release-downloader@v1
      with:
        repository: "denoland/rusty_v8"
        tag: "v0.75.0"
        fileName: "librusty_v8_release_x86_64-unknown-linux-gnu.a"

    - run: cargo install cargo-ndk
    - run: rustup target add aarch64-linux-android

    - run: export RUSTY_V8_ARCHIVE=librusty_v8_release_aarch64-linux-android.a 
    # show build env
    - run: env
    # build `deno`
    - run: ls -ltr
    - run: pwd
    - run: cargo ndk --platform 26 --target aarch64-linux-android build --release

    # upload deno
    - uses: actions/upload-artifact@v3
      with:
        name: deno-binding-1.36.2_aarch64-linux-android
        path: ../target/aarch64-linux-android/release/deno.so
